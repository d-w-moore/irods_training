#-------------------------------------------------------------------------------------------------------
#     Setup for the January 2020 COMPUTE TO DATA Training / Demonstration                       
#-------------------------------------------------------------------------------------------------------

Setup is similar to what is outlined at:

  http://slides.com/irods/ugm2019-administration-compute-to-data#/10

but we will use this repo ( github.com/d-w-moore/irods_training ) and branch (compute_to_data_2020_01).

Also (after installing the compute-to-data and microservice-register_as_admin packages):


  1. There's a different docker image to build for this version --
  
     ubuntu $ cd ~/jupyter_container
     ubuntu $ docker build -t jupyter_sobel:latest -f Dockerfile.jupyter_sobel .


  2. add the line 'from compute_container import *' to /etc/irods/core.py. (This is all that is needed
     in terms of Python rule engine code.)


  3. Instead of the storage resources/AVUs in the UGM2019 presentation, we create the following
     setup for the data to be routed "compute-side" :

     irods $  mkdir /var/lib/irods/compute_Vault
     irods $  iadmin mkresc compute_resc unixfilesystem `hostname`:/var/lib/irods/compute_Vault
     irods $  imeta set -R compute_resc irods::resc_compute_role image_processing


  4. Create the .json data objects describing C2D applications settings --

     irods $  imkdir  /tempZone/home/configured_applications
     irods $  ichmod read public /tempZone/home/configured_applications
     irods $  ichmod inherit /tempZone/home/configured_applications
     irods $  icd /tempZone/home/configured_applications ; cd ; for x in sobel*.json; do iput -f $x . ;done
     irods $  imeta set -d sobel_execute.json   irods::compute::application  sobel_auto_run  docker
     irods $  imeta set -d sobel_notebook.json  irods::compute::application  sobel_jupyter_nb  docker


  5. set the native rulebases in the server_config to:

                    "re_rulebase_set": [
                        "compute_to_data_routing",
                        "container_calls",
                        "core"
                    ], 


#-------------------------------------------------------------------------------------------------------
#                            Running the Compute To Data Demonstration
#-------------------------------------------------------------------------------------------------------

	ubuntu $ cd ; python generate_csv_input.py >square.img.csv
	ubuntu $ icd; imkdir input_data
	ubuntu $ iput square.img.csv  input_data

To show that data object "square.img.csv" has landed in the correct storage resource:

	ubuntu $ ils -l input_data
        /tempZone/home/alice/input_data:
          alice             0 compute_resc         2080 2020-01-15.16:00 & square.img.csv


To launch the "sobel_execute.json" container synchronously:

	ubuntu $ irule -F launch_container_for_input.r \
                   '*outcoll="/tempZone/home/alice/output_synchronous"' \
                   '*app="*/sobel_execute.json"'


To show the resulting data object "edge_detected_square.img.csv" was registered,

	ubuntu $ ils /tempZone/home/alice/output_synchronous
        /tempZone/home/alice/output_synchronous:
          edge_detected_square.img.csv
          sobel_out.ipynb


To launch the "sobel_notebook.json" container interactively:

	ubuntu $ irule -F launch_container_for_input.r \
                   '*outcoll="/tempZone/home/alice/output_interactive"' \
                   '*app="*/sobel_notebook.json"'

                 After a few seconds, the URL of the interactive Jupyter notebook will appear.
                 e.g. http://0.0.0.0:8888/?token=c9e736ae61059798bd37e05cef03f6b2c3fe8d6ae0bb055c
                 ("0.0.0.0" can be replaced with the docker host machine's hostname or IP)


Open the URL in a local browser to display the Jupyter Notebook main page.


Show the iRODS delay queue watching for the interactive container to exit:

        ubuntu $ iqstat
        id     name
        10097  irods_policy_poll_application(*host, *context, *id, *attr_out, *status_out, "600")


Highlight the first Jupyter notebook cell and hit <shift-Return> to execute each cell in succession.


Show the interactive results are not yet registered in iRODS:

	ubuntu $ ils /tempZone/home/alice/output_interactive
        remote addresses: 127.0.1.1 ERROR: lsUtil: srcPath /tempZone/home/alice/output_interactive does not exist or user lacks access permission


Select the Quit button in the upper right corner of the Jupyter notebook main page. 
This will exit the notebook and the container will exit.


Show the interactive results are now registered in iRODS:

        ubuntu $ ils /tempZone/home/alice/output_interactive
        /tempZone/home/alice/output_interactive:
          edge_detected_square.img.csv


#===========================================================================================

If a VM security (or something else that is running) conflicts with the default http port (8080)
used to display the  notebook, choose a new port number and then: 

(optionally):

    * change 8080 to the new port number in Dockerfile.jupyter_sobel and rebuild the docker image
      'jupyter_sobel:latest'

(but definitely):

    * change 8080 in the sobel_notebook.json app configuration file and iput -f the modified file into 
      the collection '/tempZone/home/configured_applications'

#------------------

Notes --

If by trial and repetition more than one docker app is using the same notebook display port (or the same output
collection) as a new app instance about to be spawned, you can do the following to get rid of the old one(s): 

 $ docker rm -f $(docker ps -aql)

(using  "-aql" deletes the last docker app run, using "-aq" would terminate all running docker applications).

Probably need to another policy endpoint as a counterpart for for "docker <containerId> stop" but this
isn't quite complete yet.

